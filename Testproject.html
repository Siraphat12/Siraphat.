<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>บันทึกการใส่หมวกกันน็อก</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Sarabun', sans-serif;
      background: #f0f8ff;
      max-width: 1200px;
      margin: auto;
      padding: 20px;
    }
    h1, h2 {
      color: #1a237e;
    }
    .form-group {
      margin-bottom: 12px;
    }
    label {
      font-weight: bold;
    }
    input, select {
      width: 100%;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
      margin-top: 5px;
    }
    button {
      padding: 10px 20px;
      background-color: #3949ab;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover {
      background-color: #303f9f;
    }
    .tables {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      margin-top: 25px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #bbb;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #e3f2fd;
    }
    canvas {
      margin-top: 30px;
    }
  </style>
</head>
<body>

  <h1>บันทึกการใส่หมวกกันน็อก</h1>

  <div class="form-group">
    <label>ชื่อผู้กรอก:</label>
    <input type="text" id="nameInput" placeholder="เช่น เด็กชายเอ" />
  </div>

  <div class="form-group">
    <label>ชั้นเรียน:</label>
    <input type="text" id="classInput" placeholder="เช่น ม.2/1" />
  </div>

  <input type="date" id="dateInput" hidden />

  <div class="form-group">
    <label>การใส่หมวกกันน็อก:</label>
    <select id="helmetChoice">
      <option value="ใส่">ใส่หมวกกันน็อก</option>
      <option value="ไม่ใส่">ไม่ใส่หมวกกันน็อก</option>
    </select>
  </div>

  <div class="form-group">
    <label>จำนวนคน:</label>
    <input type="number" id="amountInput" min="1" value="1" />
  </div>

  <button onclick="addEntry()">เพิ่มข้อมูล</button>
  <button onclick="clearAll()" style="background-color:#e53935; margin-left: 10px;">ล้างข้อมูลทั้งหมด</button>

  <h2 id="chartTitle">กราฟสรุปจำนวน</h2>
  <canvas id="helmetChart"></canvas>

  <h2>ตารางข้อมูลที่บันทึก</h2>
  <div class="tables">
    <div style="flex: 1">
      <h3>ใส่หมวกกันน็อก</h3>
      <table id="tableWear">
        <thead>
          <tr>
            <th>ชื่อ</th><th>ชั้นเรียน</th><th>วันที่</th><th>วัน</th><th>จำนวน</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div style="flex: 1">
      <h3>ไม่ใส่หมวกกันน็อก</h3>
      <table id="tableNoWear">
        <thead>
          <tr>
            <th>ชื่อ</th><th>ชั้นเรียน</th><th>วันที่</th><th>วัน</th><th>จำนวน</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    let summaryData = [];
    let chart;

    function setTodayDate() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      const formatted = `${yyyy}-${mm}-${dd}`;
      document.getElementById("dateInput").value = formatted;
    }

    function getDayName(dateStr) {
      const days = ['อาทิตย์', 'จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์', 'เสาร์'];
      const date = new Date(dateStr);
      return days[date.getDay()];
    }

    function addEntry() {
      const name = document.getElementById("nameInput").value.trim();
      const className = document.getElementById("classInput").value.trim();
      const date = document.getElementById("dateInput").value;
      const choice = document.getElementById("helmetChoice").value;
      const amount = parseInt(document.getElementById("amountInput").value);

      if (!name || !className || !date || isNaN(amount) || amount <= 0) {
        alert("กรุณากรอกข้อมูลให้ครบและถูกต้อง");
        return;
      }

      const dayName = getDayName(date);
      summaryData.push({ name, className, date, dayName, choice, amount });
      saveToLocal();
      updateTables();
      updateChart();
    }

    function updateTables() {
      const wearBody = document.getElementById("tableWear").querySelector("tbody");
      const noWearBody = document.getElementById("tableNoWear").querySelector("tbody");
      wearBody.innerHTML = "";
      noWearBody.innerHTML = "";

      summaryData.forEach(entry => {
        const row = `<tr>
          <td>${entry.name}</td>
          <td>${entry.className}</td>
          <td>${entry.date}</td>
          <td>${entry.dayName}</td>
          <td>${entry.amount}</td>
        </tr>`;
        if (entry.choice === "ใส่") wearBody.innerHTML += row;
        else noWearBody.innerHTML += row;
      });
    }

    function updateChart() {
      const total = { 'ใส่': 0, 'ไม่ใส่': 0 };
      summaryData.forEach(entry => total[entry.choice] += entry.amount);

      const labels = ["ใส่หมวกกันน็อก", "ไม่ใส่หมวกกันน็อก"];
      const values = [total['ใส่'], total['ไม่ใส่']];
      const colors = ['#4caf50', '#f44336'];

      document.getElementById('chartTitle').innerText = `กราฟสรุปจำนวน (ใส่: ${total['ใส่']} คน, ไม่ใส่: ${total['ไม่ใส่']} คน)`;

      if (chart) {
        chart.data.datasets[0].data = values;
        chart.update();
      } else {
        const ctx = document.getElementById('helmetChart').getContext('2d');
        chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'จำนวนคน',
              data: values,
              backgroundColor: colors,
              borderRadius: 10
            }]
          },
          options: {
            responsive: true,
            indexAxis: 'y',
            scales: {
              x: {
                beginAtZero: true,
                title: { display: true, text: 'จำนวนคน' }
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: ctx => ` ${ctx.label}: ${ctx.raw} คน`
                }
              }
            }
          }
        });
      }
    }

    function clearAll() {
      if (confirm("คุณแน่ใจหรือไม่ว่าต้องการล้างข้อมูลทั้งหมด?")) {
        summaryData = [];
        localStorage.removeItem('helmetData');
        updateTables();
        updateChart();
        document.getElementById('chartTitle').innerText = "กราฟสรุปจำนวน";
      }
    }

    function saveToLocal() {
      localStorage.setItem('helmetData', JSON.stringify(summaryData));
    }

    function loadFromLocal() {
      const saved = localStorage.getItem('helmetData');
      if (saved) {
        summaryData = JSON.parse(saved);
        updateTables();
        updateChart();
      }
    }

    function autoClearIfMonday() {
      const today = new Date();
      if (today.getDay() === 1) { // 1 = Monday
        const lastClear = localStorage.getItem('lastClear');
        const todayStr = today.toISOString().split('T')[0];
        if (lastClear !== todayStr) {
          summaryData = [];
          localStorage.removeItem('helmetData');
          localStorage.setItem('lastClear', todayStr);
        }
      }
    }

    window.onload = function () {
      setTodayDate();
      autoClearIfMonday();
      loadFromLocal();
    }
  </script>

</body>
</html>
